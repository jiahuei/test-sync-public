name: Sync to Public Repo

on:
  push:
    branches:
      - main

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout private repo
        uses: actions/checkout@v5

      - name: Setup Git
        run: |
          git config --global user.name "${{ github.event.head_commit.author.name }}"
          git config --global user.email "${{ github.event.head_commit.author.email }}"

      - name: Run cleanup script
        run: |
          # Run your script to strip private code
          bash scripts/remove_cloud_modules.sh

      - name: Checkout public repo
        uses: actions/checkout@v5
        with:
          repository: jiahuei/test-sync-public
          ssh-key: ${{ secrets.PUBLIC_DEPLOY_KEY }}
          path: public-repo

      - name: Sync changes
        run: |
          # Copy files (excluding .git)
          rsync -av --exclude='.git' --exclude='public-repo' --delete ./ public-repo/

          cd public-repo

          # Check if there are changes
          if [[ -n $(git status -s) ]]; then
            git add .
            
            # Commit with original author info
            GIT_AUTHOR_NAME="${{ github.event.head_commit.author.name }}" \
            GIT_AUTHOR_EMAIL="${{ github.event.head_commit.author.email }}" \
            GIT_COMMITTER_NAME="${{ github.event.head_commit.author.name }}" \
            GIT_COMMITTER_EMAIL="${{ github.event.head_commit.author.email }}" \
            git commit -m "${{ github.event.head_commit.message }}"
            
            git push
          else
            echo "No changes to sync"
          fi
